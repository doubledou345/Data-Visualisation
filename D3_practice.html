<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <style>
            .node {
              stroke: #000;
              stroke-width: 1.5px;
            }

            .link {
              stroke: #900;
              stroke-width: 1.5px;
            }
            
            div.tooltip {
                position: absolute;
                width: 135px;
                height: auto;
                padding: 10px;
                font: 12px Arial;
                background-color: darkgrey;
                -webkit-border-radius: 10px;
                -moz-border-radius: 10px;
                border-radius: 10px;
                -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
                -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
                box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
                pointer-events: none;
            }
        </style>
    </head>
    <body>
        <svg width="1200" height="600"></svg>
        <script src="https://d3js.org/d3.v4.min.js">
        <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
        <script>

            var svg = d3.select("svg"),
                width = svg.attr("width"),
                height = svg.attr("height");
            
            svg.style("border", "solid 1px");
            
            var link = svg.selectAll(".link"),
                node = svg.selectAll(".node");

            d3.json("D3_practice_data.json", function(error, graph) {
                if (error) throw error;
                
                var simulation = d3.forceSimulation()
                    .force("charge", d3.forceManyBody().strength(-200))
                    .force("link", d3.forceLink().id(function(d) { return d.id; }).distance(450))
                    .force("xAxis", d3.forceX(width / 2))
                    .force("yAxis", d3.forceY(height / 2))
                    .on("tick", ticked);

                simulation.nodes(graph.nodes);
                
                links = [];
                siteAmount = [];
                connected = {};
                siteConnection = {};
                                
                function update(key, value, dict){
                    if (key in dict){
                        dict[key] = value + dict[key];
                    }else{
                        dict[key] = value;
                    }
                };
                
                graph.links.forEach(d => {
                    links.push({'source':d.node01, 'target':d.node02, 'weight':d.amount});
                    connected[`${d.node01},${d.node02}`] = 1;
                    update(d.node01, d.amount, siteAmount);
                    update(d.node02, d.amount, siteAmount); 
                    update(d.node01, 1, siteConnection);
                    update(d.node02, 1, siteConnection);
                });
                
                simulation.force("link").links(links);
                
                link = link
                    .data(links)
                    .enter().append("line")
                    .attr("class", "link")
                    .style("stroke-width", function(d){return d.weight / 50;});

                node = node
                    .data(graph.nodes)
                    .enter().append("circle")
                    .attr("class", "node")
                    .attr("cx", function(d){return d.x;})
                    .attr("cy", function(d){return d.y;})
                    .attr("r", function(d){return siteAmount[d.id] / 100;});
                
                node.on("mouseover", hightlight(0.2))
                    .on("mouseout", hightlight(1));
                
                var tip = d3.select("body")
                    .append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0);
                
                function ticked() {
                    link.attr("x1", function(d) { return d.source.x; })
                        .attr("y1", function(d) { return d.source.y; })
                        .attr("x2", function(d) { return d.target.x; })
                        .attr("y2", function(d) { return d.target.y; });
                    
                    node.attr("cx", function(d) { return d.x; })
                        .attr("cy", function(d) { return d.y; });
                }
            
                function isConnected(a, b) {
                    return connected[`${a.id},${b.id}`] || connected[`${b.id},${a.id}`];
                }
                
                function isLinked(n, l){
                    return l.source.id === n.id || l.target.id === n.id;
                }

                function hightlight(opacity) {
                    return function(d){
                        node.attr("opacity", function(o){
                            const thisOpacity = isConnected(d,o) ? 1 : opacity;
                            return thisOpacity;
                        });
                        d3.select(this)
                            .attr("opacity",1);
                        
                        link.attr("opacity", function(o){
                            const thisOpacity = isLinked(d, o) ? 1 : opacity;
                            return thisOpacity;
                        });
                        
                        if (opacity != 1){
                            tip.transition().style("opacity",0.9);
                            tip.html('Position: ' + d.id + '<p>Amount: ' + siteAmount[d.id] + '</p><p>Connections: ' + siteConnection[d.id] + '</p>');
                            tip.style('left', (d.x + 10) + 'px')
                                .style('top', (d.y + 20) + 'px');
                        }else{
                            tip.style("opacity", 0);
                        };
                    }
                }
            });

            

        </script>
    </body>
</html>